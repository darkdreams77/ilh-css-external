name: Comment Changed Files & Tag on PR with CDN URLs

on:
  push:
    branches:
      - main

jobs:
  comment-pr:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get short SHA
        id: sha
        run: echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Get list of changed files and CDN URLs
        id: files
        run: |
          git fetch origin ${{ github.event.before }}
          FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" | sed 's/^/- /' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "cdn_urls<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" | sed "s|^|https://cdn.jsdelivr.net/gh/${{ github.repository }}@${GITHUB_SHA:0:7}/|" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Find pull request
        id: find_pr
        uses: juliangruber/find-pull-request-action@v1

      - uses: marocchino/sticky-pull-request-comment@v2
        with:
            message: |
                📝 **Pré-release tag \`${{ steps.sha.outputs.short_sha }}\` créée.**

                🔧 Fichiers modifiés :
                ${`\n${{ steps.files.outputs.changed_files }}`.trim()}

                🌐 URLs via jsDelivr :
                \`\`\`txt
                ${`\n${{ steps.files.outputs.cdn_urls }}`.trim()}
                \`\`\``
