name: Comment Changed Files & CDN URLs on PR

on: pull_request

permissions:
  pull-requests: write

jobs:
  comment-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get short SHA
        id: sha
        run: echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Get changed files in PR and generate CDN URLs
        id: pr_files
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const repo = process.env.GITHUB_REPOSITORY;
            const sha = process.env.GITHUB_SHA.substring(0, 7);

            const filtered = files.filter(f => !f.filename.startsWith(".github/"));

            const fileList = filtered.map(f => `- ${f.filename}`).join('\n');
            const cdnList = filtered.map(f => `<link href="https://cdn.jsdelivr.net/gh/${repo}@${sha}/${f.filename}" rel="stylesheet" type="text/css">`).join('\n');

            core.setOutput("fileList", fileList);
            core.setOutput("cdnList", cdnList);
          result-encoding: string

      - name: Comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ðŸš€ New tag pre-released: `${{ steps.sha.outputs.short_sha }}`

            ðŸ’» Changed files:
            ```txt
            ${{ steps.pr_files.outputs.fileList }}
            ```


            ðŸ‘¾ <link /> tags to copy:
            ```txt
            ${{ steps.pr_files.outputs.cdnList }}
            ```
