name: Comment Changed Files & Tag on PR with CDN URLs

on: pull_request

permissions:
  pull-requests: write

jobs:
  comment-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get short SHA
        id: sha
        run: echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Get list of changed files and CDN URLs
        id: files
        run: |
          git fetch origin ${{ github.event.before }}
          FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" | sed 's/^/- /' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "cdn_urls<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" | sed "s|^|https://cdn.jsdelivr.net/gh/${{ github.repository }}@${GITHUB_SHA:0:7}/|" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Find Pull Request
        id: find_pr
        uses: juliangruber/find-pull-request-action@v1

      - name: Comment on PR with full file list
        if: steps.find_pr.outputs.number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = Number('${{ steps.find_pr.outputs.number }}');
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const fileList = files.map(f => `- ${f.filename}`).join('\n');
            echo "changed_files_list=$fileList" >> $GITHUB_OUTPUT

      - uses: marocchino/sticky-pull-request-comment@v2
        with:
            message: |
                ğŸ“ **PrÃ©-release tag `${{ steps.sha.outputs.short_sha }}` crÃ©Ã©e.**

                ğŸ”§ Fichiers modifiÃ©s :
                ```txt
                ${{ steps.files.outputs.changed_files_list }}
                ${{ steps.files.outputs.changed_files }}
                ```

                ğŸŒ URLs via jsDelivr :
                ```txt
                ${{ steps.files.outputs.cdn_urls }}
                ```
