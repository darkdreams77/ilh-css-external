name: Comment Changed Files & CDN URLs on PR

on: pull_request

permissions:
  pull-requests: write

jobs:
  comment-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get short SHA
        id: sha
        run: echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Get changed files in PR and generate CDN URLs
        id: pr_files
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const prNumber = context.payload.pull_request.number;
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const shortSha = process.env.GITHUB_SHA.substring(0, 7);
            const repo = process.env.GITHUB_REPOSITORY;

            const filtered = files.filter(f => !f.filename.startsWith(".github/"));

            const fileList = filtered.map(f => `- ${f.filename}`).join('\n');
            const cdnList = filtered.map(f => `https://cdn.jsdelivr.net/gh/${repo}@${shortSha}/${f.filename}`).join('\n');

            const output = `ğŸ“ **PrÃ©-release tag \`${shortSha}\` crÃ©Ã©e.**\nğŸ”§ Fichiers modifiÃ©s :\n\`\`\`txt${fileList}\`\`\`\n\nğŸŒ URLs via jsDelivr :\n\`\`\`txt${cdnList}\`\`\``;

            return output;

      - name: Comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: ${{ steps.pr_files.outputs.result }}
